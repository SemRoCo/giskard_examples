#
# Copyright (C) 2015-2016 Georg Bartels <georg.bartels@cs.uni-bremen.de>
#
# This file is part of giskard.
#
# giskard is free software; you can redistribute it and/or
# modify it under the terms of the GNU General Public License
# as published by the Free Software Foundation; either version 2
# of the License, or (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
#

scope:
  # definition of some nice short-cuts
  - unit_x: {vector3: [1, 0, 0]}
  - unit_y: {vector3: [0, 1, 0]}
  - unit_z: {vector3: [0, 0, 1]}


  # definition of joint input variables
  - triangle_base_joint_var:
      input-var: 0
  - left_arm_0_joint_var:
      input-var: 1
  - left_arm_1_joint_var:
      input-var: 2
  - left_arm_2_joint_var:
      input-var: 3
  - left_arm_3_joint_var:
      input-var: 4
  - left_arm_4_joint_var:
      input-var: 5
  - left_arm_5_joint_var:
      input-var: 6
  - left_arm_6_joint_var:
      input-var: 7
  - right_arm_0_joint_var:
      input-var: 8 
  - right_arm_1_joint_var:
      input-var: 9 
  - right_arm_2_joint_var:
      input-var: 10
  - right_arm_3_joint_var:
      input-var: 11
  - right_arm_4_joint_var:
      input-var: 12
  - right_arm_5_joint_var:
      input-var: 13
  - right_arm_6_joint_var:
      input-var: 14

  # definition goal input variables
  - l_goal_x: {input-var: 15}
  - l_goal_y: {input-var: 16}
  - l_goal_z: {input-var: 17}
  - l_goal_rot_z: {input-var: 18}
  - l_goal_rot_y: {input-var: 19}
  - l_goal_rot_x: {input-var: 20}
  - r_goal_x: {input-var: 21}
  - r_goal_y: {input-var: 22}
  - r_goal_z: {input-var: 23}
  - r_goal_rot_z: {input-var: 24}
  - r_goal_rot_y: {input-var: 25}
  - r_goal_rot_x: {input-var: 26}

  # definition of joint transforms
  # torso
  - base_footprint_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0.36
                - 0.25
                - 0.16
  - triangle_base_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector-add:
                - scale-vector:
                    - triangle_base_joint_var
                    - vector3:
                        - 0
                        - 0
                        - 1
                - vector3:
                    - 0.0786889663592487
                    - 0.09863515797381039
                    - 0.996332096493862
  # left arm
  - triangle_left_arm_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0.134209
                - -0.240707
                - 0.181709
        - frame:
            - quaternion:
                - -0.0004729371180698978
                - 0.4995655083948626
                - 0.8662636938907295
                - 0.004614304172038954
            - vector3:
                - 0
                - 0
                - 0
  - triangle_left_arm_link_left_arm_base_joint_frame:
      frame-mul:
        - frame:
            - quaternion:
                - 0
                - 0
                - 0.5000001943375614
                - 0.8660252915835663
            - vector3:
                - 0
                - 0
                - 0
  - left_arm_0_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - left_arm_0_joint_var
            - vector3:
                - 0
                - 0
                - 0.11
  - left_arm_1_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - -1
                    - 0
                - left_arm_1_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - left_arm_2_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - left_arm_2_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - left_arm_3_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 1
                    - 0
                - left_arm_3_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - left_arm_4_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - left_arm_4_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - left_arm_5_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - -1
                    - 0
                - left_arm_5_joint_var
            - vector3:
                - 0
                - 0
                - 0.19
  - left_arm_6_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - left_arm_6_joint_var
            - vector3:
                - 0
                - 0
                - 0
  - left_arm_flange_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.078
  - left_arm_arm_cabling_adaptor_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.01
  - left_arm_adapter_iso50_kms40_joint_frame:
      frame-mul:
        - frame:
            - quaternion:
                - 0
                - 0
                - 1
                - -1.034115535551072e-13
            - vector3:
                - 0
                - 0
                - 0
  - left_arm_adapter_iso50_kms40_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.016
  - left_arm_kms40_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.027
  - left_arm_adapter_kms40_fwk050_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.01
  - left_arm_fwk_fwa_050_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.0141
  - left_arm_adapter_fwa050_wsg50_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.01
  - left_gripper_anterior_gripper_joint_frame:
      frame-mul:
        - frame:
            - quaternion:
                - 0
                - 0
                - 1
                - -1.034115535551072e-13
            - vector3:
                - 0
                - 0
                - 0
  - left_gripper_tool_frame_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.154
  # right arm
  - triangle_right_arm_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0.133262
                - -0.366684
                - 0.181581
        - frame:
            - quaternion:
                - 0.5004236110872021
                - -0.004232573192819251
                - -0.001897576527383292
                - 0.8657682680682718
            - vector3:
                - 0
                - 0
                - 0
  - triangle_right_arm_link_right_arm_base_joint_frame:
      frame-mul:
        - frame:
            - quaternion:
                - 0
                - 0
                - -0.5000001943375614
                - 0.8660252915835663
            - vector3:
                - 0
                - 0
                - 0
  - right_arm_0_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - right_arm_0_joint_var
            - vector3:
                - 0
                - 0
                - 0.11
  - right_arm_1_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - -1
                    - 0
                - right_arm_1_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - right_arm_2_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - right_arm_2_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - right_arm_3_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 1
                    - 0
                - right_arm_3_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - right_arm_4_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - right_arm_4_joint_var
            - vector3:
                - 0
                - 0
                - 0.2
  - right_arm_5_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - -1
                    - 0
                - right_arm_5_joint_var
            - vector3:
                - 0
                - 0
                - 0.19
  - right_arm_6_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 0
                    - 0
                    - 1
                - right_arm_6_joint_var
            - vector3:
                - 0
                - 0
                - 0
  - right_arm_flange_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.078
  - right_arm_arm_cabling_adaptor_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.01
  - right_arm_adapter_iso50_kms40_joint_frame:
      frame-mul:
        - frame:
            - quaternion:
                - 0
                - 0
                - 1
                - -1.034115535551072e-13
            - vector3:
                - 0
                - 0
                - 0
  - right_arm_adapter_iso50_kms40_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.016
  - right_arm_kms40_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.027
  - right_arm_adapter_kms40_fwk050_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.01
  - right_arm_fwk_fwa_050_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.0141
  - right_arm_adapter_fwa050_wsg50_trans_frame_out_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.01
  - right_gripper_anterior_gripper_joint_frame:
      frame-mul:
        - frame:
            - quaternion:
                - 0
                - 0
                - 1
                - -1.034115535551072e-13
            - vector3:
                - 0
                - 0
                - 0
  - right_gripper_tool_frame_joint_frame:
      frame-mul:
        - frame:
            - axis-angle:
                - vector3:
                    - 1
                    - 0
                    - 0
                - 0
            - vector3:
                - 0
                - 0
                - 0.154
  
  # definition of EE FK
  - left_ee:
      frame-mul:
        - base_footprint_joint_frame
        - triangle_base_joint_frame
        - triangle_left_arm_joint_frame
        - triangle_left_arm_link_left_arm_base_joint_frame
        - left_arm_0_joint_frame
        - left_arm_1_joint_frame
        - left_arm_2_joint_frame
        - left_arm_3_joint_frame
        - left_arm_4_joint_frame
        - left_arm_5_joint_frame
        - left_arm_6_joint_frame
        - left_arm_flange_joint_frame
        - left_arm_arm_cabling_adaptor_joint_frame
        - left_arm_adapter_iso50_kms40_joint_frame
        - left_arm_adapter_iso50_kms40_trans_frame_out_frame
        - left_arm_kms40_trans_frame_out_frame
        - left_arm_adapter_kms40_fwk050_trans_frame_out_frame
        - left_arm_fwk_fwa_050_trans_frame_out_frame
        - left_arm_adapter_fwa050_wsg50_trans_frame_out_frame
        - left_gripper_anterior_gripper_joint_frame
        - left_gripper_tool_frame_joint_frame
  - right_ee:
      frame-mul:
        - base_footprint_joint_frame
        - triangle_base_joint_frame
        - triangle_right_arm_joint_frame
        - triangle_right_arm_link_right_arm_base_joint_frame
        - right_arm_0_joint_frame
        - right_arm_1_joint_frame
        - right_arm_2_joint_frame
        - right_arm_3_joint_frame
        - right_arm_4_joint_frame
        - right_arm_5_joint_frame
        - right_arm_6_joint_frame
        - right_arm_flange_joint_frame
        - right_arm_arm_cabling_adaptor_joint_frame
        - right_arm_adapter_iso50_kms40_joint_frame
        - right_arm_adapter_iso50_kms40_trans_frame_out_frame
        - right_arm_kms40_trans_frame_out_frame
        - right_arm_adapter_kms40_fwk050_trans_frame_out_frame
        - right_arm_fwk_fwa_050_trans_frame_out_frame
        - right_arm_adapter_fwa050_wsg50_trans_frame_out_frame
        - right_gripper_anterior_gripper_joint_frame
        - right_gripper_tool_frame_joint_frame     

  # control params
  - pos_p_gain: -3.0
  - rot_p_gain: -1.0
  - pos_thresh: 0.05
  - rot_thresh: 0.2

  # definition EE goals and control laws
  # left arm
  - l_goal_trans: {vector3: [l_goal_x, l_goal_y, l_goal_z]}
  - l_trans: {origin-of: left_ee}
  - l_trans_error: {vector-norm: {vector-sub: [l_goal_trans, {origin-of: left_ee}]}}
  - l_trans_control: {double-mul: [pos_p_gain, {min: [pos_thresh, l_trans_error]}]}
  - l_goal_rot: 
      rotation-mul: 
        - {axis-angle: [unit_z, l_goal_rot_z]}
        - {axis-angle: [unit_y, l_goal_rot_y]}
        - {axis-angle: [unit_x, l_goal_rot_x]}
  - l_rot_error: {vector-norm: {rot-vector: {rotation-mul: [{inverse-rotation: {orientation-of: left_ee}}, l_goal_rot]}}}
  - l_rot_control: {double-mul: [rot_p_gain, {min: [rot_thresh, l_rot_error]}]}
  # right arm
  - r_goal_trans: {vector3: [r_goal_x, r_goal_y, r_goal_z]}
  - r_trans_error: {vector-norm: {vector-sub: [r_goal_trans, {origin-of: right_ee}]}}
  - r_trans_control: {double-mul: [pos_p_gain, {min: [pos_thresh, r_trans_error]}]}
  - r_goal_rot: 
      rotation-mul: 
        - {axis-angle: [unit_z, r_goal_rot_z]}
        - {axis-angle: [unit_y, r_goal_rot_y]}
        - {axis-angle: [unit_x, r_goal_rot_x]}
  - r_rot_error: {vector-norm: {rot-vector: {rotation-mul: [{inverse-rotation: {orientation-of: right_ee}}, r_goal_rot]}}}
  - r_rot_control: {double-mul: [rot_p_gain, {min: [rot_thresh, r_rot_error]}]}

  # some constants
  - weight_arm_joints: 1.0
  - weight_pos_control: 10.0
  - weight_rot_control: 30.0
#  - weight_elbow_control: 0.0
  - neg_vel_limit_arm_joints: -0.6
  - pos_vel_limit_arm_joints: 0.6

controllable-constraints:
  - controllable-constraint: [-0.02, 0.02, 100.0, 0, triangle_base_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 1, left_arm_0_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 2, left_arm_1_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 3, left_arm_2_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 4, left_arm_3_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 5, left_arm_4_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 6, left_arm_5_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 7, left_arm_6_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 8, right_arm_0_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 9, right_arm_1_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 10, right_arm_2_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 11, right_arm_3_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 12, right_arm_4_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 13, right_arm_5_joint velocity]
  - controllable-constraint: [neg_vel_limit_arm_joints, pos_vel_limit_arm_joints, weight_arm_joints, 14, right_arm_6_joint velocity]

soft-constraints:
  - soft-constraint: [l_trans_control, l_trans_control, weight_pos_control, l_trans_error, left EE position control slack]
  - soft-constraint: [l_rot_control, l_rot_control, weight_rot_control, l_rot_error, left EE rotation control slack]
#  - soft-constraint: [0.1, 0.1, weight_elbow_control, {y-coord: {origin-of: left_elbow}}, left elbow out control slack]
  - soft-constraint: [r_trans_control, r_trans_control, weight_pos_control, r_trans_error, right EE position control slack]
  - soft-constraint: [r_rot_control, r_rot_control, weight_rot_control, r_rot_error, right EE rotation control slack]
#  - soft-constraint: [-0.1, -0.1, weight_elbow_control, {y-coord: {origin-of: right_elbow}}, right elbow out control slack]

hard-constraints:
  - hard-constraint:
      - {double-sub: [-0.586, triangle_base_joint_var]}
      - {double-sub: [0.0, triangle_base_joint_var]}
      - triangle_base_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, left_arm_0_joint_var]}
      - {double-sub: [2.6, left_arm_0_joint_var]}
      - left_arm_0_joint_var
  - hard-constraint:
      - {double-sub: [-1.86, left_arm_1_joint_var]}
      - {double-sub: [1.86, left_arm_1_joint_var]}
      - left_arm_1_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, left_arm_2_joint_var]}
      - {double-sub: [2.6, left_arm_2_joint_var]}
      - left_arm_2_joint_var
  - hard-constraint:
      - {double-sub: [-1.86, left_arm_3_joint_var]}
      - {double-sub: [1.86, left_arm_3_joint_var]}
      - left_arm_3_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, left_arm_4_joint_var]}
      - {double-sub: [2.6, left_arm_4_joint_var]}
      - left_arm_4_joint_var
  - hard-constraint:
      - {double-sub: [-1.99, left_arm_5_joint_var]}
      - {double-sub: [1.99, left_arm_5_joint_var]}
      - left_arm_5_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, left_arm_6_joint_var]}
      - {double-sub: [2.6, left_arm_6_joint_var]}
      - left_arm_6_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, right_arm_0_joint_var]}
      - {double-sub: [2.6, right_arm_0_joint_var]}
      - right_arm_0_joint_var
  - hard-constraint:
      - {double-sub: [-1.86, right_arm_1_joint_var]}
      - {double-sub: [1.86, right_arm_1_joint_var]}
      - right_arm_1_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, right_arm_2_joint_var]}
      - {double-sub: [2.6, right_arm_2_joint_var]}
      - right_arm_2_joint_var
  - hard-constraint:
      - {double-sub: [-1.86, right_arm_3_joint_var]}
      - {double-sub: [1.86, right_arm_3_joint_var]}
      - right_arm_3_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, right_arm_4_joint_var]}
      - {double-sub: [2.6, right_arm_4_joint_var]}
      - right_arm_4_joint_var
  - hard-constraint:
      - {double-sub: [-1.99, right_arm_5_joint_var]}
      - {double-sub: [1.99, right_arm_5_joint_var]}
      - right_arm_5_joint_var
  - hard-constraint:
      - {double-sub: [-2.6, right_arm_6_joint_var]}
      - {double-sub: [2.6, right_arm_6_joint_var]}
      - right_arm_6_joint_var
